name: Build and Host Alpine Repo
on:
  push:
    branches:
      - master

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    container: 
      image: alpine:latest
      options: --user root
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Tools
        run: apk add --no-cache alpine-sdk doas coreutils

      - name: Setup Builder User
        run: |
          adduser -D builder
          addgroup builder abuild
          echo "permit nopass :abuild" > /etc/doas.conf
          chown root:root /etc/doas.conf
          chmod 0400 /etc/doas.conf
          mkdir -p /home/builder/.abuild
          echo "${{ secrets.APORT_PRIVATE_KEY }}" > /home/builder/.abuild/privkey.rsa
          echo "${{ secrets.APORT_PUBLIC_KEY }}" > /home/builder/.abuild/privkey.rsa.pub
          chown -R builder:builder /home/builder/.abuild
          echo "PACKAGER_PRIVKEY=\"/home/builder/.abuild/privkey.rsa\"" > /home/builder/.abuild/abuild.conf

      - name: Download Previous Repo
        uses: dawidd6/action-download-artifact@v9
        continue-on-error: true
        with:
          name: github-pages
          workflow_conclusion: success
          path: dist/
          if_no_artifact_found: ignore

      - name: Build Aports
        run: |
          git config --global --add safe.directory /github/workspace
          # Detect changed directories containing APKBUILDs
          git config --global --add safe.directory /github/workspace
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'APKBUILD' | xargs -I {} dirname {} | sort -u)
          
          mkdir -p dist/edge/main/x86_64
          
          for dir in $CHANGED_DIRS; do
            echo "Building $dir..."
            chown -R builder:builder .
            # Build and output to our distribution folder
            su builder -c "cd $dir && abuild -r -P /github/workspace/dist/edge/main"
          done

      - name: Update Repository Index
        run: |
          cd dist/edge/main/x86_64
          apk index -o APKINDEX.tar.gz *.apk
          su builder -c "abuild-sign /github/workspace/dist/edge/main/x86_64/APKINDEX.tar.gz"

      - name: Upload for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
